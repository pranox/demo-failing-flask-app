name: Demo CI

on:
  push:

jobs:
  test:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      # 1️⃣ Run failing step and capture stderr
      - name: Run failing step
        shell: powershell
        continue-on-error: true
        run: |
          python -c "import app" 2> error.txt
          exit $LASTEXITCODE

      # 2️⃣ Create JSON payload file (NO inline JSON)
      - name: Create webhook payload
        shell: powershell
        run: |
          if (Test-Path error.txt) {
            $log = Get-Content error.txt -Raw
          } else {
            $log = "Unknown CI failure"
          }

          $json = @{
            incident_id = "${{ github.run_id }}"
            log_text    = $log
          } | ConvertTo-Json -Compress

          $json | Out-File payload.json -Encoding utf8

      # 3️⃣ Send payload EXACTLY like manual curl
      - name: Send logs to AI Log Analyzer
        shell: powershell
        run: |
          curl.exe --% -X POST http://localhost:8000/webhook/ci `
            -H "Content-Type: application/json" `
            --data-binary @payload.json

      # 4️⃣ Fail job
      - name: Mark job failed
        shell: powershell
        run: exit 1
