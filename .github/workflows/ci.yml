name: Demo CI

on:
  push:

jobs:
  test:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------------
      # STEP 1: Run command & capture logs
      # -------------------------------
      - name: Run failing step and capture logs
        id: run_app
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host "Running failing command..."
          python -c "import app" 2>&1 | Tee-Object -FilePath error.log
          Write-Host "Exit code: $LASTEXITCODE"
          exit $LASTEXITCODE

      # -------------------------------
      # STEP 2: Send REAL logs to webhook
      # -------------------------------
      - name: Send CI logs to AI Log Analyzer
        shell: powershell
        run: |
          if (Test-Path error.log) {
            $log = Get-Content error.log -Raw

            Write-Host "Sending logs to analyzer..."
            curl.exe -X POST http://localhost:8000/webhook/ci `
              -H "Content-Type: application/json" `
              -d "{""incident_id"":""${{ github.run_id }}"",""log_text"":""$log""}"
          } else {
            Write-Host "No error.log found, nothing to send"
          }

      # -------------------------------
      # STEP 3: Fail the job if needed
      # -------------------------------
      - name: Mark job as failed
        shell: powershell
        run: |
          if (${{ steps.run_app.outcome }} -eq 'failure') {
            exit 1
          }
